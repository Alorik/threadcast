generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?  @unique
  password      String
  createdAt     DateTime @default(now())
  bio           String?
  avatarUrl     String?
  onboarded     Boolean  @default(false)
  updatedAt     DateTime @updatedAt
  username      String  @unique
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  followers     Follow[] @relation("FollowingRelation")
  following     Follow[]  @relation("FollowerRelation")
  conversations ConversationMember[]
  messages      Message[]
  
}

model Post {
  id          String   @id @default(uuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  // Thread replies (perfect, keep this)
  parentId    String?
  parent      Post?    @relation("PostToReplies", fields: [parentId], references: [id])
  replies     Post[]   @relation("PostToReplies")

  // Content
  content     String?        // ⬅️ optional now
  type        PostType       // THREAD | POST

  // Media
  media       Media[]        // ⬅️ single source of truth

  // Social
  likes       Like[]
  comments    Comment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type, createdAt])
}

enum PostType {
  THREAD   // text-only
  POST     // has media
}

model Media {
  id        String     @id @default(uuid())
  postId    String
  post      Post      @relation(fields: [postId], references: [id])
  url       String
  type      MediaType
  createdAt DateTime  @default(now())
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
}

model Like{
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])

  postId    String
  post      Post       @relation(fields: [postId], references: [id])

  createdAt DateTime  @default(now())
  @@unique([userId, postId])
}

model Comment{
  id        String     @unique @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])

  postId    String    
  post      Post       @relation(fields: [postId], references: [id])

  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Follow{
  id            String    @unique @default(uuid())
  followerId    String
  follower      User      @relation("FollowerRelation",fields: [followerId], references: [id])

  followingId   String
  following     User      @relation("FollowingRelation", fields: [followingId], references: [id])

  createdAt     DateTime      @default(now())
  @@unique([followerId, followingId])

}

model Conversation{
  id          String       @id @default(uuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  members     ConversationMember[]
  messages    Message[]

}

model ConversationMember{
  id                  String      @id @default(nanoid())
  conversationId      String
  userId              String
  joinedAt            DateTime      @default(now())

  conversation        Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  createdAt      DateTime      @default(now())

  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User          @relation(fields: [senderId], references: [id], onDelete: Cascade)
}